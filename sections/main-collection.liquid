{% comment %}
sections/main-collection.liquid
{% endcomment %}

{%- liquid

  assign products_per_page = section.settings.products_per_page
  assign products_per_row = section.settings.products_per_row

  assign show_sidebar = false
  assign show_topbar = false
  assign show_accordion_links = false

  if section.settings.show_layout_buttons or section.blocks.size > 0
    assign show_topbar = true
  endif

  if section.blocks.size > 0
    for block in section.blocks
        case block.type
          when 'menu' or 'sidebar_filter' or 'image' or 'sort_by'
            assign show_sidebar = true
          when 'menu' or 'sidebar_filter' or 'sort_by'
            assign show_accordion_links = true
        endcase
    endfor
  endif

  assign filter_count = 0
  for filter in collection.filters
    if filter.type == 'price_range'
      if filter.min_value.value != nil or filter.max_value.value != nil
        assign filter_count = 1
      endif
    endif

    assign filter_count = filter_count | plus: filter.active_values.size
  endfor

  if section.settings.show_image and collection.image != blank
    assign collection_image = true
    assign desc_width = 'span-9'
  else
    assign collection_image = false
    assign desc_width = 'span-12'
  endif

  case products_per_row
    when 2
      assign grid = 'span-6'
    when 3
      assign grid = 'span-4'
    when 4
      assign grid = 'span-3'
  endcase

-%}

{% capture collection_description %}
  <div class="rte {{ desc_width }} sm-span-12 auto">
    {{ collection.description | remove: "[banner]" }}
  </div><!-- /.rte -->
{% endcapture %}

<div class="row">
  <div class="collection-template main__section" data-section-id="{{ section.id }}" data-section-type="collection-section">
  {% paginate collection.products by products_per_page %}

    <div id="CollectionProductGrid">

      <div class="grid__wrapper">
        <div class="collection-description span-12 auto">
          <h1>{{ collection.title }}</h1>
          <div class="grid__wrapper">
            {% unless section.settings.description_bottom %}
              {{ collection_description }}
              {%- if collection_image -%}
                <div class="collection__page-image span-3 sm-span-12 auto">
                  <img src="{{ collection.image | img_url: '350x' }}" alt="{{ collection.image.alt }}">
                </div>
              {%- endif -%}
            {% endunless %}
          </div>
        </div>
      </div>

      {% if show_topbar %}
        {%
          render 'collection-topbar',
          section: section,
          collection: collection,
          filter_count: filter_count,
          show_accordion_links: show_accordion_links
        %}
      {% endif %}

      {% if show_sidebar %}
        <aside class="slideout slideout__drawer-right"
          data-wau-slideout="collection-sidebar"
          data-wau-accordions-closed
          id="slideout-collection-sidebar">

          <div class="slideout__trigger--close">
            <button class="slideout__trigger-collection-sidebar js-slideout-close button-as-link"
              data-slideout-direction="right" aria-label="Close sidebar" tabindex="0" type="button" name="button">
              <div class="icn-close"></div>
            </button>
          </div>
          {%
            render 'collection-sidebar'
            collection: collection
          %}
        </aside>
      {% endif %}

      <div class="clear"></div><!-- /.clear -->

      {%- if collection.products.size >= 1 -%}
        <div id="main-collection-product-grid"
        class="product-loop grid__wrapper"
        data-grid-type="grid"
        data-id="{{ section.id }}">
          {% for product in collection.products %}
            <div class="product-index {{ grid }} md-span-4 sm-span-6 auto {% if settings.animation != 'none' %} animate {{ settings.animation }}{% endif %}" data-alpha="{{ product.title }}" data-price="{{ product.price }}" data-product-id="{{ product.id }}">
              {% render 'product-listing',
                product: product %}
            </div>
          {% endfor %}
        </div><!-- /#main-collection-product-grid -->
      {%- else -%}
        <div id="main-collection-product-grid"
        class="collection collection--empty grid__wrapper"
        data-id="{{ section.id }}">
          <span class="rte span-8 push-2 auto">{{ 'sections.collection_template.use_fewer_filters_html' | t: link: collection.url, class: "underline" }}</span>
        </div><!-- /#main-collection-product-grid -->
      {%- endif -%}

      {% if section.settings.description_bottom %}
      <div class="lower-collection-description grid__wrapper">
          {{ collection_description }}
          {%- if collection_image -%}
            <div class="collection__page-image span-3 sm-span-12 auto">
              <img src="{{ collection.image | img_url: '350x' }}" alt="{{ collection.image.alt }}">
            </div>
          {%- endif -%}
      </div>
      {% endif %}

    </div><!-- /#CollectionProductGrid -->

    <div class="clear"></div>

    {% render 'pagination', paginate: paginate %}

    {% endpaginate %}

  </div><!-- /.collection-template -->
</div><!-- /.row -->
{% schema %}
{
  "name": "Collection",
  "max_blocks": 10,
  "settings":
  [
    {
      "type": "range",
      "id": "products_per_page",
      "min": 2,
      "max": 48,
      "step": 1,
      "label": "Products per page",
      "default": 24
    },
    {
      "type": "range",
      "id": "products_per_row",
      "min": 2,
      "max": 4,
      "step": 1,
      "label": "Products per row",
      "default": 3
    },
    {
      "type": "checkbox",
      "id": "show_image",
      "label": "Show collection image",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "description_bottom",
      "label": "Place description below products",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "show_layout_buttons",
      "label": "Show grid/list layout options",
      "default": true
    }
  ],
  "blocks":
  [
    {
      "type": "menu",
      "name": "Sidebar slideout menu",
      "settings":
      [
        {
          "type": "link_list",
          "id": "side_nav",
          "label": "Menu",
          "info": "This menu has limited support for dropdown items"
        },
        {
          "type": "text",
          "id": "header",
          "label": "Header",
          "default": "Explore"
        }
      ]
    },
    {
      "type": "sidebar_filter",
      "name": "Sidebar slideout filter",
      "limit": 1,
      "settings": [{
        "type": "paragraph",
        "content": "Learn how to add storefront filters [here](https:\/\/help.shopify.com\/en\/manual\/online-store\/themes\/os20\/customize\/filters)"
      }]
    },
    {
      "type": "sort_by",
      "name": "Sidebar slideout sort by",
      "settings":[]
    },
    {
      "type": "image",
      "name": "Sidebar slideout image",
      "settings":
      [
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image"
        },
        {
          "type": "url",
          "id": "link",
          "label": "Link"
        }
      ]
    }
  ]
}
{% endschema %}
